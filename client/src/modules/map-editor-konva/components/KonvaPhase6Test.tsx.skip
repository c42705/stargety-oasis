/**
 * Konva Map Editor - Phase 6 Test Component
 * 
 * Comprehensive test of Phase 6 advanced features:
 * - Area type visual differentiation
 * - Preview mode
 * - Keyboard shortcuts system
 * - Performance monitoring
 * - Accessibility features
 */

import React, { useState, useCallback, useMemo } from 'react';
import { Stage, Layer, Line, Rect } from 'react-konva';
import { Card, Space, Button, Typography, Row, Col, Tag, Alert, Switch, Statistic, Descriptions } from 'antd';
import {
  EyeOutlined,
  EditOutlined,
  DashboardOutlined,
  KeyOutlined,
} from '@ant-design/icons';
import type { Viewport, GridConfig, Shape, EditorTool } from '../types';
import { useKonvaZoom } from '../hooks/useKonvaZoom';
import { useKonvaGrid } from '../hooks/useKonvaGrid';
import { useKonvaSelection } from '../hooks/useKonvaSelection';
import { useKonvaTransform } from '../hooks/useKonvaTransform';
import { useKonvaHistory } from '../hooks/useKonvaHistory';
import { useKonvaPreviewMode } from '../hooks/useKonvaPreviewMode';
import { useKonvaPerformance } from '../hooks/useKonvaPerformance';
import { useKonvaAccessibility } from '../hooks/useKonvaAccessibility';
import { useKonvaKeyboardShortcuts, KeyboardShortcut } from '../hooks/useKonvaKeyboardShortcuts';
import { useKonvaLayers } from '../hooks/useKonvaLayers';
import { TransformableRect, TransformablePolygon, TransformerComponent } from './TransformableShape';
import { SelectionRect } from './SelectionRect';
import { createRectangleShape, createPolygonShape } from '../utils/shapeFactories';
import { VIEWPORT_DEFAULTS, GRID_DEFAULTS, CANVAS } from '../constants/konvaConstants';

const { Title, Text } = Typography;

export const KonvaPhase6Test: React.FC = () => {
  // ==========================================================================
  // STATE
  // ==========================================================================

  const [viewport, setViewport] = useState<Viewport>(VIEWPORT_DEFAULTS);
  const [gridConfig] = useState<GridConfig>(GRID_DEFAULTS);
  const [shapes, setShapes] = useState<Shape[]>([]);
  const [selectedIds, setSelectedIds] = useState<string[]>([]);

  // ==========================================================================
  // HOOKS
  // ==========================================================================

  // Zoom hook
  const { zoomIn, zoomOut, handleWheel, zoomPercentage } = useKonvaZoom({
    viewport,
    onViewportChange: setViewport,
  });

  // Grid hook
  const { gridLines, shouldRenderGrid } = useKonvaGrid({
    config: gridConfig,
    canvasWidth: CANVAS.DEFAULT_WIDTH,
    canvasHeight: CANVAS.DEFAULT_HEIGHT,
    viewport,
  });

  // Selection hook
  const selection = useKonvaSelection({
    enabled: true,
    shapes,
    onSelectionChange: setSelectedIds,
  });

  // Transform hook
  const transform = useKonvaTransform({
    selectedIds,
    shapes,
    onShapeUpdate: (id, updates) => {
      setShapes((prev) =>
        prev.map((shape) =>
          shape.id === id ? { ...shape, ...updates } : shape
        )
      );
    },
  });

  // History hook
  const history = useKonvaHistory({
    currentState: { shapes, selectedIds },
    onStateRestore: (state) => {
      setShapes(state.shapes);
      setSelectedIds(state.selectedIds);
    },
  });

  // Preview mode hook
  const previewMode = useKonvaPreviewMode({
    initialPreviewMode: false,
  });

  // Performance monitoring hook
  const performance = useKonvaPerformance({
    shapes,
    enabled: true,
  });

  // Accessibility hook
  const accessibility = useKonvaAccessibility({
    shapes,
    selectedIds,
    enabled: true,
  });

  // Keyboard shortcuts
  const shortcuts: KeyboardShortcut[] = useMemo(() => [
    { key: 'z', ctrl: true, description: 'Undo', action: history.undo, enabled: history.canUndo },
    { key: 'y', ctrl: true, description: 'Redo', action: history.redo, enabled: history.canRedo },
    { key: 'a', ctrl: true, description: 'Select All', action: selection.selectAll },
    { key: 'Delete', description: 'Delete Selected', action: () => {
      setShapes((prev) => prev.filter((s) => !selectedIds.includes(s.id)));
      setSelectedIds([]);
    }, enabled: selectedIds.length > 0 },
    { key: 'p', ctrl: true, description: 'Toggle Preview', action: previewMode.togglePreview },
    { key: 'g', description: 'Toggle Grid', action: () => {} },
  ], [history, selection, selectedIds, previewMode]);

  const keyboardShortcuts = useKonvaKeyboardShortcuts({
    enabled: true,
    shortcuts,
  });

  // Layer management
  const { layers: layerRefs } = useKonvaLayers();

  // ==========================================================================
  // SHAPE MANAGEMENT
  // ==========================================================================

  const handleAddCollisionArea = useCallback(() => {
    const newShape = createRectangleShape({
      x: 100 + shapes.length * 20,
      y: 100 + shapes.length * 20,
      width: 150,
      height: 100,
      category: 'collision',
    });
    setShapes((prev) => [...prev, newShape]);
    accessibility.announceAction('Collision area added');
  }, [shapes.length, accessibility]);

  const handleAddInteractiveArea = useCallback(() => {
    const offset = shapes.length * 20;
    const newShape = createPolygonShape({
      vertices: [
        { x: 400 + offset, y: 150 + offset },
        { x: 500 + offset, y: 150 + offset },
        { x: 550 + offset, y: 250 + offset },
        { x: 450 + offset, y: 300 + offset },
        { x: 350 + offset, y: 250 + offset },
      ],
      category: 'interactive',
    });
    setShapes((prev) => [...prev, newShape]);
    accessibility.announceAction('Interactive area added');
  }, [shapes.length, accessibility]);

  // ==========================================================================
  // RENDER
  // ==========================================================================

  return (
    <div style={{ padding: '20px' }}>
      <Title level={2}>Phase 6: Advanced Features Test</Title>
      
      {/* Performance Warnings */}
      {performance.warnings.map((warning, i) => (
        <Alert
          key={i}
          message={warning.message}
          type={warning.severity === 'high' ? 'error' : 'warning'}
          showIcon
          style={{ marginBottom: '16px' }}
        />
      ))}
      
      <Row gutter={16}>
        {/* Canvas */}
        <Col span={16}>
          <Card title={previewMode.isPreviewMode ? 'Preview Mode' : 'Edit Mode'} style={{ marginBottom: '16px' }}>
            <div style={{ border: '1px solid #d9d9d9', overflow: 'hidden' }}>
              <Stage
                width={800}
                height={600}
                scaleX={viewport.zoom}
                scaleY={viewport.zoom}
                x={viewport.pan.x}
                y={viewport.pan.y}
                onWheel={handleWheel}
                onClick={previewMode.canEdit ? selection.handleStageClick : undefined}
                onMouseDown={previewMode.canEdit ? selection.handleMouseDown : undefined}
                onMouseMove={previewMode.canEdit ? selection.handleMouseMove : undefined}
                onMouseUp={previewMode.canEdit ? selection.handleMouseUp : undefined}
              >
                {/* Grid Layer */}
                <Layer ref={layerRefs.gridLayer}>
                  {shouldRenderGrid && gridLines.map((line, i) => (
                    <Line
                      key={i}
                      points={line.points}
                      stroke={line.stroke}
                      strokeWidth={line.strokeWidth}
                      opacity={line.opacity}
                      listening={false}
                    />
                  ))}
                </Layer>

                {/* Shapes Layer */}
                <Layer ref={layerRefs.shapesLayer}>
                  {shapes.map((shape) => {
                    const isSelected = selection.isSelected(shape.id) && previewMode.canEdit;
                    
                    if (shape.geometry.type === 'rectangle') {
                      return (
                        <TransformableRect
                          key={shape.id}
                          shape={shape}
                          isSelected={isSelected}
                          onSelect={() => previewMode.canEdit && selection.selectShape(shape.id)}
                          onDragEnd={(e) => transform.handleDragEnd(shape.id, e)}
                          onTransformEnd={(node) => transform.handleTransformEnd(shape.id, node)}
                        />
                      );
                    } else if (shape.geometry.type === 'polygon') {
                      return (
                        <TransformablePolygon
                          key={shape.id}
                          shape={shape}
                          isSelected={isSelected}
                          onSelect={() => previewMode.canEdit && selection.selectShape(shape.id)}
                          onDragEnd={(e) => transform.handleDragEnd(shape.id, e)}
                          onTransformEnd={(node) => transform.handleTransformEnd(shape.id, node)}
                        />
                      );
                    }
                    return null;
                  })}
                  
                  {/* Transformer (only in edit mode) */}
                  {previewMode.canEdit && <TransformerComponent selectedShapeIds={selectedIds} />}
                </Layer>

                {/* Selection Layer (only in edit mode) */}
                {previewMode.canEdit && (
                  <Layer ref={layerRefs.uiLayer}>
                    <SelectionRect rect={selection.selectionRect} />
                  </Layer>
                )}
              </Stage>
            </div>
          </Card>
        </Col>

        {/* Controls */}
        <Col span={8}>
          {/* Preview Mode */}
          <Card title="Preview Mode" size="small" style={{ marginBottom: '16px' }}>
            <Space direction="vertical" style={{ width: '100%' }}>
              <div>
                <Text strong>Mode: </Text>
                <Tag color={previewMode.isPreviewMode ? 'blue' : 'green'}>
                  {previewMode.isPreviewMode ? 'Preview' : 'Edit'}
                </Tag>
              </div>
              <Button
                onClick={previewMode.togglePreview}
                icon={previewMode.isPreviewMode ? <EditOutlined /> : <EyeOutlined />}
                block
              >
                {previewMode.isPreviewMode ? 'Enable Editing' : 'Preview Mode'} (Ctrl+P)
              </Button>
            </Space>
          </Card>

          {/* Performance */}
          <Card title="Performance" size="small" style={{ marginBottom: '16px' }} extra={<DashboardOutlined />}>
            <Space direction="vertical" style={{ width: '100%' }}>
              <Row gutter={8}>
                <Col span={12}>
                  <Statistic title="FPS" value={performance.metrics.fps} suffix="fps" />
                </Col>
                <Col span={12}>
                  <Statistic title="Shapes" value={performance.metrics.shapeCount} />
                </Col>
              </Row>
              <div>
                <Text strong>Status: </Text>
                <Tag color={performance.isPerformanceGood ? 'green' : 'orange'}>
                  {performance.isPerformanceGood ? 'Good' : 'Degraded'}
                </Tag>
              </div>
            </Space>
          </Card>

          {/* Shapes */}
          <Card title="Add Shapes" size="small" style={{ marginBottom: '16px' }}>
            <Space direction="vertical" style={{ width: '100%' }}>
              <Button onClick={handleAddCollisionArea} block disabled={previewMode.isPreviewMode}>
                Add Collision Area (Red)
              </Button>
              <Button onClick={handleAddInteractiveArea} block disabled={previewMode.isPreviewMode}>
                Add Interactive Area (Green)
              </Button>
            </Space>
          </Card>

          {/* Keyboard Shortcuts */}
          <Card title="Keyboard Shortcuts" size="small" extra={<KeyOutlined />}>
            <Space direction="vertical" style={{ fontSize: '12px', width: '100%' }}>
              {shortcuts.map((shortcut, i) => (
                <div key={i}>
                  <Text strong>{keyboardShortcuts.getShortcutDisplay(shortcut)}</Text>
                  {' - '}
                  <Text>{shortcut.description}</Text>
                </div>
              ))}
            </Space>
          </Card>
        </Col>
      </Row>
    </div>
  );
};

